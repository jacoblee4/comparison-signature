(function executeRule(current, previous) {
    
    gs.info('SIGNATURE HELPER BR: ========== Business Rule Started ==========');
    
    try {
        var documentRecord = current.document_id.getRefRecord();
        
        if (!documentRecord || !documentRecord.isValidRecord()) {
            gs.error('SIGNATURE HELPER BR: Document record invalid');
            return;
        }

        var parentSysId;
        var documentTableName = documentRecord.getTableName();

        if (documentTableName == 'x_banun_bunow_si_0_credit_authority_limits' || 
            documentTableName == 'x_banun_bunow_si_0_non_credit_authority_limits') {
            var parent = documentRecord.parent.getRefRecord();
            if (!parent || !parent.isValidRecord()) {
                return;
            }
            parentSysId = parent.sys_id.toString();
        } else {
            parentSysId = documentRecord.sys_id.toString();
        }

        // Check if PDF already exists
        var existingPDF = new GlideRecord('sys_attachment');
        existingPDF.addQuery('table_name', 'x_banun_bunow_si_0_signature_request');
        existingPDF.addQuery('table_sys_id', parentSysId);
        existingPDF.addQuery('file_name', 'CONTAINS', 'Authority_Limits_Comparison');
        existingPDF.addQuery('file_name', 'ENDSWITH', '.pdf');
        existingPDF.query();

        if (existingPDF.hasNext()) {
            gs.info('SIGNATURE HELPER BR: PDF already exists, skipping');
            return;
        }

        // Get parent record
        var parentRec = new GlideRecord('x_banun_bunow_si_0_signature_request');
        if (!parentRec.get(parentSysId)) {
            return;
        }
        
        gs.info('SIGNATURE HELPER BR: Generating PDF for ' + parentRec.number);

        // Build HTML content
        var helper = new x_banun_bunow_si_0.SignatureHelper();
        var htmlContent = helper._buildHTMLContent(parentRec);
        
        if (!htmlContent) {
            gs.warn('SIGNATURE HELPER BR: No HTML content generated');
            return;
        }
        
        gs.info('SIGNATURE HELPER BR: HTML content generated, length = ' + htmlContent.length);
        
        // Step 1: Create temporary HTML attachment
        var tempFileName = 'temp_comparison_' + parentRec.number + '.html';
        var sa = new GlideSysAttachment();
        
        var htmlAttachmentSysId = sa.write(
            parentRec,
            tempFileName,
            'text/html',
            htmlContent
        );
        
        if (!htmlAttachmentSysId) {
            gs.error('SIGNATURE HELPER BR: Failed to create temp HTML');
            return;
        }
        
        gs.info('SIGNATURE HELPER BR: Temp HTML created: ' + htmlAttachmentSysId);
        
        // Step 2: Convert HTML attachment to PDF using print-to-PDF
        var pdfFileName = 'Authority_Limits_Comparison_' + parentRec.number + '.pdf';
        
        gs.info('SIGNATURE HELPER BR: Converting HTML to PDF...');
        
        var renderer = new sn_pdfgeneratorutils.PDFGenerationAPI();
        var pdfAttachmentSysId = renderer.convertAttachmentToPDF(
            htmlAttachmentSysId,
            pdfFileName
        );
        
        gs.info('SIGNATURE HELPER BR: PDF conversion result = ' + pdfAttachmentSysId);
        
        if (pdfAttachmentSysId) {
            gs.info('SIGNATURE HELPER BR: PDF created successfully: ' + pdfAttachmentSysId);
            
            // Step 3: Delete the temporary HTML file
            var tempHTML = new GlideRecord('sys_attachment');
            if (tempHTML.get(htmlAttachmentSysId)) {
                tempHTML.deleteRecord();
                gs.info('SIGNATURE HELPER BR: Temp HTML deleted');
            }
            
            // Verify PDF exists
            var verifyPDF = new GlideRecord('sys_attachment');
            if (verifyPDF.get(pdfAttachmentSysId)) {
                gs.info('SIGNATURE HELPER BR: PDF VERIFIED');
                gs.info('SIGNATURE HELPER BR: - File name: ' + verifyPDF.file_name);
                gs.info('SIGNATURE HELPER BR: - Size: ' + verifyPDF.size_bytes + ' bytes');
            }
        } else {
            gs.error('SIGNATURE HELPER BR: PDF conversion failed');
        }

    } catch (e) {
        gs.error('SIGNATURE HELPER BR: Exception: ' + e.message);
        gs.error('SIGNATURE HELPER BR: Stack: ' + e.stack);
    }
    
    gs.info('SIGNATURE HELPER BR: ========== Business Rule Ended ==========');

})(current, previous);
