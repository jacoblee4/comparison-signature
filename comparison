(function executeRule(current, previous) {
    
    try {
        var documentRecord = current.document_id.getRefRecord();
        
        if (!documentRecord || !documentRecord.isValidRecord()) {
            return;
        }

        var parentSysId;
        var documentTableName = documentRecord.getTableName();

        if (documentTableName == 'x_banun_bunow_si_0_credit_authority_limits' || 
            documentTableName == 'x_banun_bunow_si_0_non_credit_authority_limits') {
            var parent = documentRecord.parent.getRefRecord();
            if (!parent || !parent.isValidRecord()) {
                return;
            }
            parentSysId = parent.sys_id.toString();
        } else {
            parentSysId = documentRecord.sys_id.toString();
        }

        // Check if PDF already exists on parent
        var existingPDF = new GlideRecord('sys_attachment');
        existingPDF.addQuery('table_name', 'x_banun_bunow_si_0_signature_request');
        existingPDF.addQuery('table_sys_id', parentSysId);
        existingPDF.addQuery('file_name', 'CONTAINS', 'Authority_Limits_Comparison');
        existingPDF.addQuery('file_name', 'ENDSWITH', '.pdf');
        existingPDF.query();

        if (existingPDF.hasNext()) {
            gs.info('PDF already exists for request, skipping generation');
            return;
        }

        // Get parent record
        var parentRec = new GlideRecord('x_banun_bunow_si_0_signature_request');
        if (!parentRec.get(parentSysId)) {
            return;
        }
        
        // Build HTML content
        var helper = new x_banun_bunow_si_0.SignatureHelper();
        var htmlContent = helper._buildHTMLContent(parentRec);
        
        if (!htmlContent) {
            return;
        }

        var pdfFileName = 'Authority_Limits_Comparison_' + parentRec.number + '.pdf';

        // Configure header/footer for landscape PDF
        var hfInfo = {
            "FooterText": "Authority Limits Comparison - Generated: " + new GlideDateTime().getDisplayValue(),
            "PageSize": "A4",
            "Orientation": "LANDSCAPE",
            "GeneratePageNumber": "true",
            "FooterTextAlignment": "BOTTOM_CENTER",
            "TopOrBottomMargin": "20",
            "LeftOrRightMargin": "20"
        };
        
        // Generate PDF attached to PARENT record
        var pdfAPI = new sn_pdfgeneratorutils.PDFGenerationAPI();
        var result = pdfAPI.convertToPDFWithHeaderFooter(
            htmlContent,
            parentRec.getTableName(),
            parentRec.sys_id.toString(),
            pdfFileName,
            hfInfo
        );
        
        if (result && result.status == 'success' && result.attachment_id) {
            gs.info('PDF generated successfully, attachment_id: ' + result.attachment_id);
            
            // NOW ALSO ATTACH TO THE APPROVAL RECORD
            var sa = new GlideSysAttachment();
            
            // Get the PDF content from parent attachment
            var parentAttachment = new GlideRecord('sys_attachment');
            if (parentAttachment.get(result.attachment_id)) {
                
                // Get the approval record
                var approvalGR = new GlideRecord('sysapproval_approver');
                if (approvalGR.get(current.sys_id)) {
                    
                    // Copy PDF to approval record
                    var copiedAttachmentId = sa.copy(
                        'x_banun_bunow_si_0_signature_request',
                        parentRec.sys_id.toString(),
                        'sysapproval_approver',
                        current.sys_id.toString(),
                        result.attachment_id
                    );
                    
                    if (copiedAttachmentId) {
                        gs.info('PDF copied to approval record: ' + copiedAttachmentId);
                    } else {
                        gs.error('Failed to copy PDF to approval record');
                    }
                }
            }
        }

    } catch (e) {
        gs.error('PDF Generation Exception: ' + e.message);
    }

})(current, previous);
