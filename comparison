//BR

(function executeRule(current, previous /*null when async*/) {
    
    gs.info('SIGNATURE HELPER: ========== PDF Generation Business Rule Started ==========');
    gs.info('SIGNATURE HELPER: Approval sys_id = ' + current.sys_id);
    gs.info('SIGNATURE HELPER: Approval state = ' + current.state);
    gs.info('SIGNATURE HELPER: Approval source_table = ' + current.source_table);
    
    try {
        // Get the document record (could be parent or child)
        gs.info('SIGNATURE HELPER: Attempting to retrieve document record...');
        var documentRecord = current.document_id.getRefRecord();
        
        if (!documentRecord || !documentRecord.isValidRecord()) {
            gs.error('SIGNATURE HELPER: Unable to retrieve document record from sysapproval_approver');
            gs.error('SIGNATURE HELPER: document_id value = ' + current.getValue('document_id'));
            return;
        }
        
        gs.info('SIGNATURE HELPER: Document record retrieved successfully');
        
        var documentTableName = documentRecord.getTableName();
        gs.info('SIGNATURE HELPER: Document table name = ' + documentTableName);
        gs.info('SIGNATURE HELPER: Document sys_id = ' + documentRecord.sys_id);
        
        var parentSysId;

        // Determine if document is parent or child and get parent sys_id
        if (documentTableName == 'x_banun_bunow_si_0_credit_authority_limits' || 
            documentTableName == 'x_banun_bunow_si_0_non_credit_authority_limits') {
            gs.info('SIGNATURE HELPER: Document is a CHILD record, retrieving parent...');
            
            // Document is child - get parent
            var parent = documentRecord.parent.getRefRecord();
            if (!parent || !parent.isValidRecord()) {
                gs.error('SIGNATURE HELPER: Unable to retrieve parent from child record');
                gs.error('SIGNATURE HELPER: Child parent field value = ' + documentRecord.getValue('parent'));
                return;
            }
            parentSysId = parent.sys_id.toString();
            gs.info('SIGNATURE HELPER: Parent retrieved from child successfully');
            gs.info('SIGNATURE HELPER: Parent sys_id = ' + parentSysId);
            gs.info('SIGNATURE HELPER: Parent number = ' + parent.number);
            
        } else if (documentTableName == 'x_banun_bunow_si_0_signature_request') {
            gs.info('SIGNATURE HELPER: Document is the PARENT record');
            // Document is parent
            parentSysId = documentRecord.sys_id.toString();
            gs.info('SIGNATURE HELPER: Parent sys_id = ' + parentSysId);
            gs.info('SIGNATURE HELPER: Parent number = ' + documentRecord.number);
        } else {
            gs.error('SIGNATURE HELPER: Unexpected document table name: ' + documentTableName);
            return;
        }

        // Check if PDF already exists for this request
        gs.info('SIGNATURE HELPER: Checking for existing PDF attachments...');
        var existingPDF = new GlideRecord('sys_attachment');
        existingPDF.addQuery('table_name', 'x_banun_bunow_si_0_signature_request');
        existingPDF.addQuery('table_sys_id', parentSysId);
        existingPDF.addQuery('file_name', 'CONTAINS', 'Authority_Limits_Comparison');
        existingPDF.query();

        if (existingPDF.hasNext()) {
            gs.info('SIGNATURE HELPER: PDF already exists for this request, skipping generation');
            gs.info('SIGNATURE HELPER: Existing PDF file name = ' + existingPDF.file_name);
            return;
        }
        
        gs.info('SIGNATURE HELPER: No existing PDF found, proceeding with generation...');

        // Generate the PDF
        gs.info('SIGNATURE HELPER: Instantiating SignatureHelper...');
        var pdfGen = new x_banun_bunow_si_0.SignatureHelper();
        gs.info('SIGNATURE HELPER: SignatureHelper instantiated successfully');
        
        gs.info('SIGNATURE HELPER: Calling generateComparisonPDF with parentSysId = ' + parentSysId);
        var attachmentSysId = pdfGen.generateComparisonPDF(parentSysId);
        
        gs.info('SIGNATURE HELPER: generateComparisonPDF returned: ' + attachmentSysId);

        if (attachmentSysId) {
            gs.info('SIGNATURE HELPER: PDF generation SUCCESS! Attachment sys_id = ' + attachmentSysId);
            
            // Verify the attachment was created
            var verifyAttachment = new GlideRecord('sys_attachment');
            if (verifyAttachment.get(attachmentSysId)) {
                gs.info('SIGNATURE HELPER: Verified attachment exists:');
                gs.info('SIGNATURE HELPER:   - File name: ' + verifyAttachment.file_name);
                gs.info('SIGNATURE HELPER:   - Table name: ' + verifyAttachment.table_name);
                gs.info('SIGNATURE HELPER:   - Table sys_id: ' + verifyAttachment.table_sys_id);
                gs.info('SIGNATURE HELPER:   - File size: ' + verifyAttachment.size_bytes + ' bytes');
            } else {
                gs.error('SIGNATURE HELPER: Attachment sys_id returned but cannot retrieve attachment record!');
            }
        } else {
            gs.warn('SIGNATURE HELPER: PDF generation returned NULL - check PDF Generation logs above');
        }

    } catch (e) {
        gs.error('SIGNATURE HELPER: Business Rule Exception: ' + e.message);
        gs.error('SIGNATURE HELPER: Exception stack trace: ' + e.stack);
    }
    
    gs.info('SIGNATURE HELPER: ========== PDF Generation Business Rule Ended ==========');

})(current, previous);

















//Script include
generateComparisonPDF: function(parentSysId) {
    gs.info('SIGNATURE HELPER PDF: generateComparisonPDF called with parentSysId = ' + parentSysId);
    
    var parent = new GlideRecord('x_banun_bunow_si_0_signature_request');
    if (!parent.get(parentSysId)) {
        gs.error('SIGNATURE HELPER PDF: Unable to retrieve parent record with sys_id: ' + parentSysId);
        return null;
    }

    gs.info('SIGNATURE HELPER PDF: Parent record retrieved: ' + parent.number);
    gs.info('SIGNATURE HELPER PDF: Starting HTML content generation...');

    // Build the HTML content
    var htmlContent = this._buildHTMLContent(parent);

    if (!htmlContent) {
        gs.error('SIGNATURE HELPER PDF: No HTML content generated - _buildHTMLContent returned null');
        return null;
    }
    
    gs.info('SIGNATURE HELPER PDF: HTML content generated successfully, length = ' + htmlContent.length + ' characters');

    // Generate PDF
    try {
        gs.info('SIGNATURE HELPER PDF: Instantiating PDFGenerationAPI...');
        var pdfGenerator = new sn_pdfgeneratorutils.PDFGenerationAPI();
        
        gs.info('SIGNATURE HELPER PDF: Calling convertToPDF...');
        var pdfOutput = pdfGenerator.convertToPDF(htmlContent);
        
        gs.info('SIGNATURE HELPER PDF: convertToPDF completed, checking result...');

        if (!pdfOutput || !pdfOutput.getSysId()) {
            gs.error('SIGNATURE HELPER PDF: Failed to create PDF - pdfOutput is null or has no sys_id');
            gs.error('SIGNATURE HELPER PDF: pdfOutput = ' + pdfOutput);
            return null;
        }

        var attachmentSysId = pdfOutput.getSysId();
        gs.info('SIGNATURE HELPER PDF: PDF created with attachment sys_id = ' + attachmentSysId);

        // Update the attachment to link it to the parent record with proper name
        gs.info('SIGNATURE HELPER PDF: Updating attachment record...');
        var attachmentGR = new GlideRecord('sys_attachment');
        if (attachmentGR.get(attachmentSysId)) {
            gs.info('SIGNATURE HELPER PDF: Attachment record found, updating fields...');
            attachmentGR.table_name = 'x_banun_bunow_si_0_signature_request';
            attachmentGR.table_sys_id = parent.sys_id.toString();
            attachmentGR.file_name = 'Authority_Limits_Comparison_' + parent.number + '.pdf';
            attachmentGR.update();

            gs.info('SIGNATURE HELPER PDF: Successfully created and attached PDF');
            gs.info('SIGNATURE HELPER PDF: Final file name = ' + attachmentGR.file_name);
            return attachmentSysId;
        } else {
            gs.error('SIGNATURE HELPER PDF: Could not retrieve attachment record with sys_id: ' + attachmentSysId);
        }

    } catch (e) {
        gs.error('SIGNATURE HELPER PDF: Exception during PDF generation: ' + e.message);
        gs.error('SIGNATURE HELPER PDF: Exception stack: ' + e.stack);
        return null;
    }

    gs.error('SIGNATURE HELPER PDF: Reached end of function without returning - this should not happen');
    return null;
},

_buildHTMLContent: function(parent) {
    gs.info('SIGNATURE HELPER HTML: _buildHTMLContent started');
    
    // Function to get value or return 0
    function safeGetValue(glideRecord, fieldName) {
        var value = glideRecord.getValue(fieldName);
        return parseFloat(value) || 0;
    }
    
    // ... rest of your code
